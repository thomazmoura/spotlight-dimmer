name: Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      tag:
        description: 'Release tag (e.g., v1.0.0)'
        required: true
        type: string

jobs:
  build-and-release:
    permissions:
      contents: write
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Get version from tag
        id: version
        shell: pwsh
        run: |
          if ("${{ github.event_name }}" -eq "workflow_dispatch") {
            $version = "${{ inputs.tag }}"
          } else {
            $version = "${{ github.ref_name }}"
          }

          # Remove 'v' prefix for version number
          $versionNumber = $version -replace '^v', ''

          echo "version=$versionNumber" | Out-File -FilePath $Env:GITHUB_OUTPUT -Append
          echo "tag=$version" | Out-File -FilePath $Env:GITHUB_OUTPUT -Append

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '10.0.x'

      - name: Restore dependencies
        run: dotnet restore SpotlightDimmer.sln

      - name: Build x64 - SpotlightDimmer.WindowsClient with AOT
        run: dotnet publish SpotlightDimmer.WindowsClient/SpotlightDimmer.WindowsClient.csproj -c Release -r win-x64 -o publish/x64

      - name: Build x64 - SpotlightDimmer.Config with AOT
        run: dotnet publish SpotlightDimmer.Config/SpotlightDimmer.Config.csproj -c Release -r win-x64 -o publish/x64

      - name: Build ARM64 - SpotlightDimmer.WindowsClient with AOT
        run: dotnet publish SpotlightDimmer.WindowsClient/SpotlightDimmer.WindowsClient.csproj -c Release -r win-arm64 -o publish/arm64

      - name: Build ARM64 - SpotlightDimmer.Config with AOT
        run: dotnet publish SpotlightDimmer.Config/SpotlightDimmer.Config.csproj -c Release -r win-arm64 -o publish/arm64

      - name: Verify build outputs
        shell: pwsh
        run: |
          Write-Host "Checking x64 build outputs:"
          Get-ChildItem -Path publish/x64 -Force | Format-Table Name, Length

          if (-not (Test-Path "publish/x64/SpotlightDimmer.exe")) {
            Write-Host "::error::x64 SpotlightDimmer.exe not found!"
            exit 1
          }

          if (-not (Test-Path "publish/x64/SpotlightDimmer.Config.exe")) {
            Write-Host "::error::x64 SpotlightDimmer.Config.exe not found!"
            exit 1
          }

          Write-Host "‚úì x64 executables built successfully"

          Write-Host "`nChecking ARM64 build outputs:"
          Get-ChildItem -Path publish/arm64 -Force | Format-Table Name, Length

          if (-not (Test-Path "publish/arm64/SpotlightDimmer.exe")) {
            Write-Host "::error::ARM64 SpotlightDimmer.exe not found!"
            exit 1
          }

          if (-not (Test-Path "publish/arm64/SpotlightDimmer.Config.exe")) {
            Write-Host "::error::ARM64 SpotlightDimmer.Config.exe not found!"
            exit 1
          }

          Write-Host "‚úì ARM64 executables built successfully"

      - name: Install Inno Setup
        shell: pwsh
        run: |
          choco install innosetup -y --no-progress

          # Add Inno Setup to PATH
          $innoPath = "C:\Program Files (x86)\Inno Setup 6"
          echo $innoPath | Out-File -FilePath $Env:GITHUB_PATH -Append

      - name: Build Inno Setup installers
        shell: pwsh
        run: |
          # Build x64 installer
          Write-Host "Building x64 installer..."
          & "C:\Program Files (x86)\Inno Setup 6\ISCC.exe" `
            "/DAppVersion=${{ steps.version.outputs.version }}" `
            spotlight-dimmer-x64.iss

          if ($LASTEXITCODE -ne 0) {
            Write-Host "::error::x64 Inno Setup compilation failed with exit code $LASTEXITCODE"
            exit 1
          }

          Write-Host "‚úì x64 installer created successfully"

          # Build ARM64 installer
          Write-Host "`nBuilding ARM64 installer..."
          & "C:\Program Files (x86)\Inno Setup 6\ISCC.exe" `
            "/DAppVersion=${{ steps.version.outputs.version }}" `
            spotlight-dimmer-arm64.iss

          if ($LASTEXITCODE -ne 0) {
            Write-Host "::error::ARM64 Inno Setup compilation failed with exit code $LASTEXITCODE"
            exit 1
          }

          Write-Host "‚úì ARM64 installer created successfully"

          # List generated installers
          Write-Host "`nGenerated installers:"
          Get-ChildItem -Path dist -Filter "*.exe" | ForEach-Object {
            Write-Host "  - $($_.Name) ($([math]::Round($_.Length / 1MB, 2)) MB)"
          }

      - name: Prepare installer assets
        shell: pwsh
        run: |
          # Find x64 installer
          $installerX64 = Get-ChildItem -Path dist -Filter 'spotlight-dimmer-installer-x64.exe' | Select-Object -First 1

          if (-not $installerX64) {
            Write-Host "::error::x64 installer not found in dist/"
            Write-Host "dist/ contents:"
            Get-ChildItem -Path dist -Force | Format-List FullName
            exit 1
          }

          Write-Host "Found x64 installer: $($installerX64.FullName)"

          # Find ARM64 installer
          $installerArm64 = Get-ChildItem -Path dist -Filter 'spotlight-dimmer-installer-arm64.exe' | Select-Object -First 1

          if (-not $installerArm64) {
            Write-Host "::error::ARM64 installer not found in dist/"
            exit 1
          }

          Write-Host "Found ARM64 installer: $($installerArm64.FullName)"

          # Store paths as environment variables
          "INSTALLER_X64_PATH=$($installerX64.Name)" | Out-File -FilePath $Env:GITHUB_ENV -Append
          "INSTALLER_ARM64_PATH=$($installerArm64.Name)" | Out-File -FilePath $Env:GITHUB_ENV -Append

      - name: Create ZIP archives
        shell: pwsh
        run: |
          # Create x64 ZIP archive
          $zipX64 = "spotlight-dimmer-windows-x64.zip"

          Compress-Archive -Path `
            publish/x64/SpotlightDimmer.exe, `
            publish/x64/SpotlightDimmer.Config.exe, `
            spotlight-dimmer-icon.ico, `
            spotlight-dimmer-icon-paused.ico, `
            README.md, `
            CONFIGURATION.md `
            -DestinationPath $zipX64

          Write-Host "‚úì Created $zipX64"

          # Create ARM64 ZIP archive
          $zipArm64 = "spotlight-dimmer-windows-arm64.zip"

          Compress-Archive -Path `
            publish/arm64/SpotlightDimmer.exe, `
            publish/arm64/SpotlightDimmer.Config.exe, `
            spotlight-dimmer-icon.ico, `
            spotlight-dimmer-icon-paused.ico, `
            README.md, `
            CONFIGURATION.md `
            -DestinationPath $zipArm64

          Write-Host "‚úì Created $zipArm64"

          # Store paths as environment variables
          "ZIP_X64_PATH=$zipX64" | Out-File -FilePath $Env:GITHUB_ENV -Append
          "ZIP_ARM64_PATH=$zipArm64" | Out-File -FilePath $Env:GITHUB_ENV -Append

      - name: Upload x64 installer artifact
        uses: actions/upload-artifact@v4
        with:
          name: windows-installer-x64
          path: dist/${{ env.INSTALLER_X64_PATH }}
          retention-days: 1

      - name: Upload ARM64 installer artifact
        uses: actions/upload-artifact@v4
        with:
          name: windows-installer-arm64
          path: dist/${{ env.INSTALLER_ARM64_PATH }}
          retention-days: 1

      - name: Upload x64 ZIP artifact
        uses: actions/upload-artifact@v4
        with:
          name: windows-portable-x64
          path: ${{ env.ZIP_X64_PATH }}
          retention-days: 1

      - name: Upload ARM64 ZIP artifact
        uses: actions/upload-artifact@v4
        with:
          name: windows-portable-arm64
          path: ${{ env.ZIP_ARM64_PATH }}
          retention-days: 1

      - name: Extract changelog
        id: changelog
        shell: pwsh
        run: |
          $changelog = & "./SpotlightDimmer.Scripts/Extract-Changelog.ps1"

          # Save the changelog content to output
          # Use multiline string format for GitHub Actions
          $delimiter = "CHANGELOG_EOF_$(Get-Random)"
          "changelog<<$delimiter" | Out-File -FilePath $Env:GITHUB_OUTPUT -Append
          $changelog | Out-File -FilePath $Env:GITHUB_OUTPUT -Append
          $delimiter | Out-File -FilePath $Env:GITHUB_OUTPUT -Append

          Write-Host "Extracted changelog:"
          Write-Host $changelog

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ steps.version.outputs.tag }}
          name: 'Spotlight Dimmer ${{ steps.version.outputs.tag }}'
          body: |
            ${{ steps.changelog.outputs.changelog }}

            ---

            ## Installation

            ### Windows Installer (Recommended)

            **Download the appropriate installer for your system:**
            - **x64 (Intel/AMD)**: `spotlight-dimmer-installer-x64.exe` - For traditional Windows PCs
            - **ARM64**: `spotlight-dimmer-installer-arm64.exe` - For Surface, Snapdragon laptops

            The installer:
            - ‚úÖ Requires **no admin rights** (per-user installation)
            - ‚úÖ Creates Start Menu shortcuts with proper icons
            - ‚úÖ Can be uninstalled via Windows Settings > Apps
            - ‚úÖ Ultra-compact (~2 MB installer overhead)
            - ‚úÖ **Native binaries** - No emulation, best performance and battery life

            ### Portable ZIP (Alternative)

            **Download the appropriate ZIP for your system:**
            - **x64 (Intel/AMD)**: `spotlight-dimmer-windows-x64.zip`
            - **ARM64**: `spotlight-dimmer-windows-arm64.zip`

            Extract all files to the same folder to keep the icons alongside the executables.

            ## What's Spotlight Dimmer?

            Spotlight Dimmer is a Windows utility that creates semi-transparent overlays to dim inactive displays or regions, creating a "spotlight" effect on the active window.

            **Key Features:**
            - üéØ **Multi-monitor support** with event-driven focus tracking
            - üîÑ **Three dimming modes**: FullScreen, Partial, and PartialWithActive
            - ‚ö° **Hot-reloadable config** at `%AppData%\SpotlightDimmer\config.json`
            - üöÄ **Native AOT compilation** for fast startup and small binaries
            - üíæ **Zero-allocation hot path** design for minimal GC pressure
            - üñ•Ô∏è **Full ARM64 support** for Windows on ARM devices (Surface, Snapdragon)

            ---

            ü§ñ *Generated with [Claude Code](https://claude.com/claude-code)*
          draft: false
          prerelease: ${{ contains(steps.version.outputs.tag, 'beta') || contains(steps.version.outputs.tag, 'alpha') || contains(steps.version.outputs.tag, 'rc') }}
          files: |
            dist/${{ env.INSTALLER_X64_PATH }}
            dist/${{ env.INSTALLER_ARM64_PATH }}
            ${{ env.ZIP_X64_PATH }}
            ${{ env.ZIP_ARM64_PATH }}
