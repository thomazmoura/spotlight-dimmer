name: Publish to Winget

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to publish (e.g., 0.9.0)'
        required: true
        type: string

jobs:
  publish-winget:
    runs-on: windows-latest
    permissions:
      contents: read
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Validate version format
        shell: pwsh
        run: |
          $version = "${{ inputs.version }}"
          if ($version -notmatch '^\d+\.\d+\.\d+(-[a-zA-Z0-9\.]+)?$') {
            Write-Error "Invalid version format: $version. Expected format: x.y.z or x.y.z-prerelease"
            exit 1
          }
          Write-Host "‚úÖ Version format validated: $version"

      - name: Check if release exists
        shell: pwsh
        run: |
          $version = "${{ inputs.version }}"
          $releaseUrl = "https://api.github.com/repos/${{ github.repository }}/releases/tags/v$version"

          try {
            $headers = @{
              "Accept" = "application/vnd.github+json"
              "X-GitHub-Api-Version" = "2022-11-28"
            }
            $response = Invoke-RestMethod -Uri $releaseUrl -Headers $headers
            Write-Host "‚úÖ Release v$version found"
            Write-Host "   Release URL: $($response.html_url)"
            Write-Host "   Published: $($response.published_at)"
          } catch {
            Write-Error "‚ùå Release v$version not found. Please create and publish the release first."
            Write-Host "   Checked URL: $releaseUrl"
            exit 1
          }

      - name: Install winget-create
        shell: pwsh
        run: |
          Write-Host "Installing winget-create..."
          Invoke-WebRequest -Uri https://aka.ms/wingetcreate/latest -OutFile wingetcreate.exe

          if (Test-Path wingetcreate.exe) {
            $fileInfo = Get-Item wingetcreate.exe
            Write-Host "‚úÖ winget-create downloaded successfully ($($fileInfo.Length) bytes)"
          } else {
            Write-Error "Failed to download winget-create"
            exit 1
          }

      - name: Generate Winget manifest
        shell: pwsh
        run: |
          $version = "${{ inputs.version }}"
          $installerX64Url = "https://github.com/${{ github.repository }}/releases/download/v$version/spotlight-dimmer-installer-x64.exe"
          $installerArm64Url = "https://github.com/${{ github.repository }}/releases/download/v$version/spotlight-dimmer-installer-arm64.exe"

          Write-Host "`n========================================="
          Write-Host "Generating Winget manifest"
          Write-Host "=========================================`n"
          Write-Host "Package ID: ThomazMoura.SpotlightDimmer"
          Write-Host "Version: $version"
          Write-Host "x64 Installer: $installerX64Url"
          Write-Host "ARM64 Installer: $installerArm64Url"
          Write-Host ""

          # Generate manifest locally (without --submit for testing first)
          # --urls: Multiple installer URLs separated by pipe (|)
          # --version: Version number
          # --architecture-override: Force architecture detection (x64|arm64)
          # --out: Output directory for generated manifest files
          .\wingetcreate.exe update ThomazMoura.SpotlightDimmer `
            --urls "$installerX64Url|$installerArm64Url" `
            --version "$version" `
            --architecture-override "x64|arm64" `
            --out "manifests"

          if ($LASTEXITCODE -ne 0) {
            Write-Error "‚ùå winget-create failed with exit code $LASTEXITCODE"
            exit $LASTEXITCODE
          }

          Write-Host "`n‚úÖ Winget manifest generated successfully!"
          Write-Host "Manifest location: manifests\"

          # List generated manifest files
          Get-ChildItem -Path "manifests" -Recurse -File | ForEach-Object {
            Write-Host "  - $($_.FullName)"
          }

      - name: Test local Winget installation (x64 only)
        shell: pwsh
        run: |
          $version = "${{ inputs.version }}"

          Write-Host "`n========================================="
          Write-Host "Testing Winget Installation (x64)"
          Write-Host "=========================================`n"
          Write-Host "Note: Testing x64 installer only on this runner."
          Write-Host "ARM64 installer will be validated by Winget infrastructure."
          Write-Host ""

          # Find the manifest directory (should be manifests/t/ThomazMoura/SpotlightDimmer/{version}/)
          $manifestPath = Get-ChildItem -Path "manifests" -Recurse -Filter "ThomazMoura.SpotlightDimmer.yaml" | Select-Object -First 1

          if (-not $manifestPath) {
            Write-Error "‚ùå Manifest file not found in manifests/"
            exit 1
          }

          $manifestDir = $manifestPath.DirectoryName
          Write-Host "üì¶ Installing from manifest: $manifestDir"
          Write-Host "   Winget will automatically select x64 installer on this x64 runner."
          Write-Host ""

          # Install using the local manifest
          Write-Host "`n1Ô∏è‚É£ Installing SpotlightDimmer..."
          winget install --manifest $manifestDir --silent --accept-package-agreements --accept-source-agreements

          if ($LASTEXITCODE -ne 0) {
            Write-Error "‚ùå Winget installation failed with exit code $LASTEXITCODE"
            exit 1
          }

          Write-Host "‚úÖ Installation completed"
          Start-Sleep -Seconds 2

          # Find the installed executable
          $programFiles = ${env:ProgramFiles}
          $exePath = Join-Path $programFiles "Spotlight Dimmer\SpotlightDimmer.exe"

          if (-not (Test-Path $exePath)) {
            # Try user-level installation path
            $localAppData = ${env:LOCALAPPDATA}
            $exePath = Join-Path $localAppData "Programs\Spotlight Dimmer\SpotlightDimmer.exe"
          }

          if (-not (Test-Path $exePath)) {
            Write-Error "‚ùå SpotlightDimmer.exe not found after installation"
            Write-Host "Expected locations:"
            Write-Host "  - ${env:ProgramFiles}\Spotlight Dimmer\SpotlightDimmer.exe"
            Write-Host "  - ${env:LOCALAPPDATA}\Programs\Spotlight Dimmer\SpotlightDimmer.exe"
            exit 1
          }

          Write-Host "‚úÖ Found executable: $exePath"

          # Launch the application
          Write-Host "`n2Ô∏è‚É£ Launching SpotlightDimmer..."
          $process = Start-Process -FilePath $exePath -PassThru

          if (-not $process) {
            Write-Error "‚ùå Failed to start SpotlightDimmer.exe"
            exit 1
          }

          Write-Host "‚úÖ Application launched (PID: $($process.Id))"
          Write-Host "‚è≥ Waiting 10 seconds for initialization..."
          Start-Sleep -Seconds 10

          # Close the application gracefully
          Write-Host "`n3Ô∏è‚É£ Closing application..."
          if (-not $process.HasExited) {
            $process.CloseMainWindow() | Out-Null
            Start-Sleep -Seconds 2

            if (-not $process.HasExited) {
              Write-Host "‚ö†Ô∏è  Main window close didn't work, forcing stop..."
              $process.Kill()
            }
          }

          Write-Host "‚úÖ Application closed"

          # Check logs
          Write-Host "`n4Ô∏è‚É£ Checking application logs..."
          $logsDir = Join-Path ${env:APPDATA} "SpotlightDimmer\logs"

          if (-not (Test-Path $logsDir)) {
            Write-Error "‚ùå Logs directory not found: $logsDir"
            exit 1
          }

          $logFiles = Get-ChildItem -Path $logsDir -Filter "spotlight-*.log" | Sort-Object LastWriteTime -Descending

          if ($logFiles.Count -eq 0) {
            Write-Error "‚ùå No log files found in: $logsDir"
            exit 1
          }

          $latestLog = $logFiles[0]
          Write-Host "‚úÖ Found log file: $($latestLog.Name)"
          Write-Host "   Size: $($latestLog.Length) bytes"
          Write-Host "   Modified: $($latestLog.LastWriteTime)"

          # Read and analyze the log
          $logContent = Get-Content -Path $latestLog.FullName -Raw

          if ([string]::IsNullOrWhiteSpace($logContent)) {
            Write-Error "‚ùå Log file is empty"
            exit 1
          }

          Write-Host "‚úÖ Log file contains $($logContent.Length) characters"

          # Check for errors
          $errorLines = Get-Content -Path $latestLog.FullName | Where-Object { $_ -match '\[ERR\]' }

          if ($errorLines.Count -gt 0) {
            Write-Error "‚ùå Found $($errorLines.Count) error(s) in log file:"
            $errorLines | ForEach-Object {
              Write-Host "   $_" -ForegroundColor Red
            }
            exit 1
          }

          Write-Host "‚úÖ No errors found in log file"

          # Display first 20 lines of log for visibility
          Write-Host "`nüìã Log preview (first 20 lines):"
          Write-Host "----------------------------------------"
          Get-Content -Path $latestLog.FullName -TotalCount 20 | ForEach-Object {
            Write-Host "   $_"
          }
          Write-Host "----------------------------------------"

          # Uninstall the application
          Write-Host "`n5Ô∏è‚É£ Uninstalling SpotlightDimmer..."
          winget uninstall ThomazMoura.SpotlightDimmer --silent

          if ($LASTEXITCODE -ne 0) {
            Write-Warning "‚ö†Ô∏è  Winget uninstall returned exit code $LASTEXITCODE (may be expected)"
          } else {
            Write-Host "‚úÖ Uninstallation completed"
          }

          Write-Host "`n========================================="
          Write-Host "‚úÖ ALL TESTS PASSED"
          Write-Host "=========================================`n"

      - name: Submit Winget manifest
        shell: pwsh
        run: |
          $version = "${{ inputs.version }}"
          $installerX64Url = "https://github.com/${{ github.repository }}/releases/download/v$version/spotlight-dimmer-installer-x64.exe"
          $installerArm64Url = "https://github.com/${{ github.repository }}/releases/download/v$version/spotlight-dimmer-installer-arm64.exe"

          Write-Host "`n========================================="
          Write-Host "Submitting Winget manifest"
          Write-Host "=========================================`n"

          # Now submit the tested manifest to microsoft/winget-pkgs
          # Both x64 and ARM64 installers will be included
          .\wingetcreate.exe update ThomazMoura.SpotlightDimmer `
            --urls "$installerX64Url|$installerArm64Url" `
            --version "$version" `
            --architecture-override "x64|arm64" `
            --token "${{ secrets.WINGET_TOKEN }}" `
            --submit

          if ($LASTEXITCODE -ne 0) {
            Write-Error "‚ùå winget-create submission failed with exit code $LASTEXITCODE"
            exit $LASTEXITCODE
          }

          Write-Host "`n‚úÖ Winget manifest submitted successfully!"
          Write-Host "   - x64 installer: spotlight-dimmer-installer-x64.exe"
          Write-Host "   - ARM64 installer: spotlight-dimmer-installer-arm64.exe"

      - name: Summary
        if: always()
        shell: pwsh
        run: |
          $version = "${{ inputs.version }}"

          Write-Host "`n========================================="
          Write-Host "Winget Publication Summary"
          Write-Host "=========================================`n"

          if ($LASTEXITCODE -eq 0) {
            Write-Host "‚úÖ SUCCESS: Manifest updated and PR submitted"
            Write-Host ""
            Write-Host "üìã Next Steps:"
            Write-Host "  1. Check your microsoft/winget-pkgs fork for the new PR"
            Write-Host "  2. The PR should be automatically created by winget-create"
            Write-Host "  3. Wait for automated validation checks to complete"
            Write-Host "  4. Address any validation failures if they occur"
            Write-Host "  5. Once checks pass, a maintainer will review and merge"
            Write-Host ""
            Write-Host "üîó Useful Links:"
            Write-Host "  - Your fork: https://github.com/YOUR_USERNAME/winget-pkgs/pulls"
            Write-Host "  - Main repo: https://github.com/microsoft/winget-pkgs/pulls"
            Write-Host "  - Package page: https://github.com/microsoft/winget-pkgs/tree/master/manifests/t/ThomazMoura/SpotlightDimmer"
          } else {
            Write-Host "‚ùå FAILED: Manifest update encountered errors"
            Write-Host ""
            Write-Host "üîç Troubleshooting:"
            Write-Host "  - Verify WINGET_TOKEN secret is configured correctly"
            Write-Host "  - Check that you have forked microsoft/winget-pkgs"
            Write-Host "  - Ensure the release v$version exists and is published"
            Write-Host "  - Review the workflow logs above for specific errors"
          }

          Write-Host "`n========================================="
