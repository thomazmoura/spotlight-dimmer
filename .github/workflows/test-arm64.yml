name: Test ARM64 Build

on:
  push:
    branches: [main]
    paths:
      - '**.cs'
      - '**.csproj'
      - '**.sln'
      - 'Directory.Build.props'
      - '**.iss'
      - '.github/workflows/test-arm64.yml'
  pull_request:
    branches: [main]
    paths:
      - '**.cs'
      - '**.csproj'
      - '**.sln'
      - 'Directory.Build.props'
      - '**.iss'
      - '.github/workflows/test-arm64.yml'
  workflow_dispatch:

jobs:
  test-arm64:
    runs-on: windows-11-arm
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '10.0.x'

      - name: Restore dependencies
        run: dotnet restore SpotlightDimmer.sln

      - name: Build ARM64 - SpotlightDimmer.WindowsClient with AOT
        run: dotnet publish SpotlightDimmer.WindowsClient/SpotlightDimmer.WindowsClient.csproj -c Release -r win-arm64 -o publish/arm64

      - name: Build ARM64 - SpotlightDimmer.Config with AOT
        run: dotnet publish SpotlightDimmer.Config/SpotlightDimmer.Config.csproj -c Release -r win-arm64 -o publish/arm64

      - name: Verify ARM64 build outputs
        shell: pwsh
        run: |
          Write-Host "Checking ARM64 build outputs:"
          Get-ChildItem -Path publish/arm64 -Force | Format-Table Name, Length

          if (-not (Test-Path "publish/arm64/SpotlightDimmer.exe")) {
            Write-Host "::error::ARM64 SpotlightDimmer.exe not found!"
            exit 1
          }

          if (-not (Test-Path "publish/arm64/SpotlightDimmer.Config.exe")) {
            Write-Host "::error::ARM64 SpotlightDimmer.Config.exe not found!"
            exit 1
          }

          Write-Host "‚úÖ ARM64 executables built successfully"

      - name: Smoke test - Launch and close SpotlightDimmer
        shell: pwsh
        run: |
          Write-Host "üöÄ Launching SpotlightDimmer.exe..."
          $process = Start-Process -FilePath "publish/arm64/SpotlightDimmer.exe" -PassThru

          if (-not $process) {
            Write-Error "‚ùå Failed to start SpotlightDimmer.exe"
            exit 1
          }

          Write-Host "‚úÖ Application launched (PID: $($process.Id))"
          Write-Host "‚è≥ Waiting 5 seconds for initialization..."
          Start-Sleep -Seconds 5

          # Close the application
          if (-not $process.HasExited) {
            $process.CloseMainWindow() | Out-Null
            Start-Sleep -Seconds 2

            if (-not $process.HasExited) {
              Write-Host "‚ö†Ô∏è  Forcing process termination..."
              $process.Kill()
            }
          }

          Write-Host "‚úÖ Application closed successfully"

      - name: Check logs
        shell: pwsh
        run: |
          $logsDir = Join-Path ${env:APPDATA} "SpotlightDimmer\logs"

          if (Test-Path $logsDir) {
            $logFiles = Get-ChildItem -Path $logsDir -Filter "spotlight-*.log" | Sort-Object LastWriteTime -Descending

            if ($logFiles.Count -gt 0) {
              $latestLog = $logFiles[0]
              Write-Host "‚úÖ Found log file: $($latestLog.Name)"
              Write-Host "   Size: $($latestLog.Length) bytes"

              # Check for errors
              $errorLines = Get-Content -Path $latestLog.FullName | Where-Object { $_ -match '\[ERR\]' }

              if ($errorLines.Count -gt 0) {
                Write-Error "‚ùå Found $($errorLines.Count) error(s) in log file"
                exit 1
              }

              Write-Host "‚úÖ No errors found in log file"
            } else {
              Write-Host "‚ÑπÔ∏è  No log files found (logging may be disabled)"
            }
          } else {
            Write-Host "‚ÑπÔ∏è  Logs directory not found (expected for quick smoke test)"
          }
